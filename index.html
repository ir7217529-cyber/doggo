<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Golden Care</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg1:#0b0b10;
      --bg2:#12121a;
      --card: rgba(31,31,38,0.92);
      --stroke: rgba(255,255,255,0.08);
      --text:#ffffff;
      --muted:#a7a7b3;
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(900px 500px at 20% 10%, #1b1b28 0%, transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, #23233a 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    .bg{ position:fixed; inset:0; pointer-events:none; z-index:0; }
    .paw{
      position:absolute; right:-40px; top:22%;
      font-size:22px; opacity:0.12;
      animation: paw-drift 10s linear infinite;
    }
    .paw:nth-child(2){ top: 38%; animation-duration: 12s; font-size: 20px; opacity:0.10; }
    .paw:nth-child(3){ top: 58%; animation-duration: 14s; font-size: 24px; opacity:0.11; }
    .paw:nth-child(4){ top: 74%; animation-duration: 11s; font-size: 21px; opacity:0.09; }
    @keyframes paw-drift{ 0%{transform:translateX(0) rotate(-10deg)} 100%{transform:translateX(-120vw) rotate(10deg)} }

    .wrap{
      max-width:720px;
      margin:0 auto;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      position:relative;
      z-index:2;
    }

    header{
      display:flex; align-items:flex-start; justify-content:space-between;
      gap:10px; margin-top:8px;
    }
    .head-left{ flex:1; min-width:0; }
    h1{ font-size:22px; margin:0; line-height:1.1; }
    .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chip-row{
      display:flex; gap:8px; align-items:center; justify-content:flex-end;
      flex-shrink:0;
    }
    .chip{
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(0,0,0,0.18);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .card{
      margin-top:12px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    /* Pet card */
    .pet-card{
      position:relative;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.12);
      overflow:hidden;
    }
    .pet-top{
      display:flex; justify-content:space-between; align-items:center;
      gap:10px; margin-bottom:10px;
    }
    .pet-title{ font-weight:900; font-size:14px; color:#fff; }
    .pet-hint{ font-size:12px; color:var(--muted); white-space:nowrap; }

    /* XP */
    .level-row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:6px; }
    .lvl{ font-weight:900; font-size:13px; color:#fff; white-space:nowrap; }
    .xptext{ color:var(--muted); font-size:12px; white-space:nowrap; }
    .xpbar{
      width:100%; height:10px; border-radius:999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden; border: 1px solid rgba(255,255,255,0.08);
      margin-top:8px;
    }
    .xpfill{ height:100%; width:30%; border-radius:999px; background: rgba(255,255,255,0.85); transition: width 220ms ease; }

    /* Mood row (–±–µ–∑ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏—Ö —Å–º–∞–π–ª–æ–≤) */
    .moodrow{
      margin-top:8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .moodtext{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      flex:1;
    }
    .moodbadges{
      display:flex;
      gap:6px;
      align-items:center;
      flex-shrink:0;
    }
    .badge{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.16);
      border-radius:999px;
      padding:4px 7px;
      font-size:12px;
      color:#fff;
      opacity:0.9;
      white-space:nowrap;
    }

    /* Dog display */
    .pet-zone{ display:flex; align-items:center; justify-content:center; padding: 8px 0 2px; }
    .pet-btn{
      border:0; background:transparent; cursor:pointer;
      padding:6px; border-radius:999px; outline:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dogwrap{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .pet{
      font-size:88px; line-height:1;
      filter: drop-shadow(0 14px 30px rgba(0,0,0,0.55));
      transform-origin: 50% 80%;
      animation: pet-idle 2.8s ease-in-out infinite;
      user-select:none;
    }
    .equip{
      font-size:34px;
      line-height:1;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,0.45));
      opacity:0.95;
    }
    @keyframes pet-idle{ 0%,100%{transform:translateY(0) rotate(-1.5deg)} 50%{transform:translateY(-6px) rotate(1.5deg)} }
    .pet.petted{ animation: pet-pet 520ms ease-out 1; }
    @keyframes pet-pet{
      0%{transform:translateY(0) scale(1) rotate(0deg)}
      35%{transform:translateY(-10px) scale(1.05) rotate(4deg)}
      70%{transform:translateY(0) scale(0.98) rotate(-4deg)}
      100%{transform:translateY(0) scale(1) rotate(0deg)}
    }

    .hearts{ position:absolute; inset:0; pointer-events:none; opacity:0; }
    .hearts.show{ opacity:1; }
    .heart{
      position:absolute; left:50%; top:55%;
      transform: translate(-50%,-50%);
      font-size:18px; opacity:0;
      animation: heart-pop 700ms ease-out forwards;
    }
    .heart:nth-child(1){ margin-left:-26px; animation-delay: 0ms; }
    .heart:nth-child(2){ margin-left: 0px;  animation-delay: 60ms; }
    .heart:nth-child(3){ margin-left: 26px; animation-delay: 120ms; }
    @keyframes heart-pop{
      0%{opacity:0; transform:translate(-50%,-50%) scale(0.7)}
      30%{opacity:0.9; transform:translate(-50%,-70%) scale(1.1)}
      100%{opacity:0; transform:translate(-50%,-120%) scale(1.0)}
    }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 420px){ .stats{ grid-template-columns: 1fr; } }
    .stat{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,0.10);
      min-width:0;
    }
    .stat-top{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:8px; font-size:12.5px; min-width:0;
    }
    .stat-name{
      display:flex; align-items:center; gap:8px;
      color: var(--muted);
      min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .stat-val{ font-variant-numeric: tabular-nums; color:#fff; opacity:0.9; flex-shrink:0; }
    .bar{
      width:100%; height:10px; border-radius:999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden; border:1px solid rgba(255,255,255,0.08);
    }
    .fill{ height:100%; width:50%; border-radius:999px; background: rgba(255,255,255,0.85); transition: width 220ms ease; }

    /* Actions */
    .actions{
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 360px){ .actions{ grid-template-columns: 1fr; } }
    button.action{
      width:100%;
      min-width:0;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:12px 12px;
      background: rgba(0,0,0,0.18);
      color:var(--text);
      text-align:left;
      cursor:pointer;
      min-height:58px;
      transition: transform 120ms ease;
    }
    button.action:active{ transform: scale(0.98); }
    .a-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; min-width:0; }
    .a-title{
      display:flex; align-items:center; gap:10px;
      font-size:14.5px; font-weight:900;
      min-width:0; flex:1;
    }
    .a-emoji{ font-size:20px; line-height:1; flex-shrink:0; }
    .a-text{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .a-plus{ font-size:20px; opacity:0.8; flex-shrink:0; }
    .a-hint{
      margin-top:6px;
      color:var(--muted);
      font-size:11.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      display:block;
    }

    .row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .btn-mini{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    .btn-mini:active{ transform: scale(0.98); }

    /* Daily quests */
    .quest{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.10);
      border-radius:12px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      min-width:0;
    }
    .q-left{ min-width:0; flex:1; }
    .q-title{ font-weight:900; font-size:13.5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .q-desc{ margin-top:2px; color:var(--muted); font-size:11.5px; }
    .q-right{ flex-shrink:0; display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
    .q-progress{ font-size:12px; color:#fff; opacity:0.9; }
    .q-claim{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color:#fff;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .q-claim:disabled{ opacity:0.45; cursor:not-allowed; }

    /* Shop */
    .shop-grid{
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 420px){ .shop-grid{ grid-template-columns: 1fr; } }
    .item{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.10);
      border-radius:12px;
      padding:10px;
      min-width:0;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .item-ico{ font-size:22px; line-height:1; flex-shrink:0; margin-top:2px; }
    .item-body{ min-width:0; flex:1; display:flex; flex-direction:column; gap:2px; }
    .item-title{ font-size:13.5px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-desc{ font-size:11.5px; color:var(--muted); }
    .item-row{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:6px; }
    .price{ font-size:12px; color:var(--muted); white-space:nowrap; }
    .btn-buy{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color:#fff;
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-buy:active{ transform: scale(0.98); }
    .btn-buy.secondary{ color:var(--muted); }

    /* Achievements */
    .ach-grid{
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 420px){ .ach-grid{ grid-template-columns: 1fr; } }
    .ach{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.10);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      opacity:0.6;
      min-width:0;
    }
    .ach.unlocked{ opacity:1; }
    .ach-ico{ font-size:20px; line-height:1; margin-top:2px; flex-shrink:0; }
    .ach-body{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .ach-title{ font-size:13.5px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ach-desc{ font-size:11.5px; color:var(--muted); }

    /* History */
    .history{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
      max-height: 260px;
      overflow:auto;
      padding-right:2px;
    }
    .log{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.10);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .log-left{ display:flex; gap:10px; align-items:flex-start; min-width:0; }
    .log-emoji{ font-size:20px; line-height:1; margin-top:1px; flex-shrink:0; }
    .log-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .log-title{ font-size:13.5px; font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .log-time{ font-size:11.5px; color:var(--muted); }

    .toast{
      position:fixed;
      left:50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12.5px;
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease, transform 180ms ease;
      z-index:3;
      backdrop-filter: blur(8px);
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-6px); }
  </style>
</head>

<body>
  <div class="bg">
    <div class="paw">üêæ</div><div class="paw">üêæ</div><div class="paw">üêæ</div><div class="paw">üêæ</div>
  </div>

  <div class="wrap">
    <header>
      <div class="head-left">
        <h1>Golden Care</h1>
        <div class="sub" id="sub">–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ—Ñ–∏–ª—å‚Ä¶</div>
      </div>
      <div class="chip-row">
        <div class="chip" id="coinChip">ü™ô 0</div>
        <div class="chip" id="chip">v2.1</div>
      </div>
    </header>

    <div class="card">
      <div class="pet-card">
        <div class="pet-top">
          <div class="pet-title" id="petTitle">–ü—ë—Å–µ–ª—å</div>
          <div class="pet-hint">–¢–∞–ø–∞–π –ø–æ –Ω–µ–º—É üêæ</div>
        </div>

        <div class="level-row">
          <div class="lvl" id="lvl">–£—Ä–æ–≤–µ–Ω—å 1</div>
          <div class="xptext" id="xptext">0 / 100 XP</div>
        </div>
        <div class="xpbar"><div class="xpfill" id="xpfill"></div></div>

        <div class="moodrow">
          <div class="moodtext" id="moodText">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ‚Ä¶</div>
          <div class="moodbadges" id="moodBadges"></div>
        </div>

        <div class="pet-zone">
          <button class="pet-btn" onclick="petDog()" aria-label="–ü–æ–≥–ª–∞–¥–∏—Ç—å —Å–æ–±–∞–∫—É">
            <div class="dogwrap">
              <div class="pet" id="petDog">üê∂</div>
              <div class="equip" id="equipEmoji"> </div>
            </div>
          </button>
        </div>

        <div class="hearts" id="hearts">
          <div class="heart">üíõ</div><div class="heart">üíõ</div><div class="heart">üíõ</div>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><div class="stat-top"><div class="stat-name">üçó –°—ã—Ç–æ—Å—Ç—å</div><div class="stat-val" id="v_hunger">‚Äî</div></div><div class="bar"><div class="fill" id="b_hunger"></div></div></div>
        <div class="stat"><div class="stat-top"><div class="stat-name">üòä –†–∞–¥–æ—Å—Ç—å</div><div class="stat-val" id="v_happy">‚Äî</div></div><div class="bar"><div class="fill" id="b_happy"></div></div></div>
        <div class="stat"><div class="stat-top"><div class="stat-name">üßº –ß–∏—Å—Ç–æ—Ç–∞</div><div class="stat-val" id="v_clean">‚Äî</div></div><div class="bar"><div class="fill" id="b_clean"></div></div></div>
        <div class="stat"><div class="stat-top"><div class="stat-name">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div><div class="stat-val" id="v_energy">‚Äî</div></div><div class="bar"><div class="fill" id="b_energy"></div></div></div>
      </div>

      <div class="actions">
        <button class="action" onclick="doAction('feed')">
          <div class="a-top"><div class="a-title"><span class="a-emoji">üçó</span><span class="a-text">–ü–æ–∫–æ—Ä–º–∏—Ç—å</span></div><div class="a-plus">Ôºã</div></div>
          <span class="a-hint" id="hint_feed">‚Ä¶</span>
        </button>

        <button class="action" onclick="doAction('walk')">
          <div class="a-top"><div class="a-title"><span class="a-emoji">ü¶Æ</span><span class="a-text">–ü–æ–≥—É–ª—è—Ç—å</span></div><div class="a-plus">Ôºã</div></div>
          <span class="a-hint" id="hint_walk">‚Ä¶</span>
        </button>

        <button class="action" onclick="doAction('groom')">
          <div class="a-top"><div class="a-title"><span class="a-emoji">üßº</span><span class="a-text">–í—ã—á–µ—Å–∞—Ç—å</span></div><div class="a-plus">Ôºã</div></div>
          <span class="a-hint" id="hint_groom">‚Ä¶</span>
        </button>

        <button class="action" onclick="doAction('train')">
          <div class="a-top"><div class="a-title"><span class="a-emoji">üéæ</span><span class="a-text">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span></div><div class="a-plus">Ôºã</div></div>
          <span class="a-hint" id="hint_train">‚Ä¶</span>
        </button>

        <button class="action" onclick="doAction('rest')">
          <div class="a-top"><div class="a-title"><span class="a-emoji">üò¥</span><span class="a-text">–û—Ç–¥–æ—Ö–Ω—É—Ç—å</span></div><div class="a-plus">Ôºã</div></div>
          <span class="a-hint" id="hint_rest">‚Ä¶</span>
        </button>

        <button class="action" onclick="doAction('treat')">
          <div class="a-top"><div class="a-title"><span class="a-emoji">ü¶¥</span><span class="a-text">–õ–∞–∫–æ–º—Å—Ç–≤–æ</span></div><div class="a-plus">Ôºã</div></div>
          <span class="a-hint" id="hint_treat">‚Ä¶</span>
        </button>
      </div>

      <div class="row">
        <button class="btn-mini" onclick="renameDog()">‚úèÔ∏è –ò–º—è</button>
        <button class="btn-mini" onclick="openReminders()">‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏</button>
        <button class="btn-mini" onclick="resetAll()">üóë –°–±—Ä–æ—Å</button>
        <button class="btn-mini" onclick="share()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      </div>
    </div>

    <!-- Daily quests -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">–ï–∂–µ–¥–Ω–µ–≤–∫–∏</div>
        <div style="color:var(--muted);font-size:12px;" id="dailyInfo">‚Äî</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:10px; margin-top:10px;" id="dailyList"></div>
    </div>

    <!-- Shop -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">–ú–∞–≥–∞–∑–∏–Ω</div>
        <div style="color:var(--muted);font-size:12px;" id="equipInfo">–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ: ‚Äî</div>
      </div>
      <div class="shop-grid" id="shopGrid"></div>
    </div>

    <!-- Achievements -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
        <div style="color:var(--muted);font-size:12px;" id="saveMode">‚Äî</div>
      </div>
      <div class="ach-grid" id="achGrid"></div>
    </div>

    <!-- History -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">–ò—Å—Ç–æ—Ä–∏—è</div>
        <div style="color:var(--muted);font-size:12px;">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div>
      </div>
      <div class="history" id="history"></div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.ready();

    const clamp = (n, a=0, b=100) => Math.max(a, Math.min(b, n));
    const now = () => Date.now();
    const el = (id) => document.getElementById(id);

    function toast(msg){
      const t = el('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1150);
    }

    // Storage
    const KEY = 'golden_care_state_v2_1';
    const canCloud = !!(tg && tg.CloudStorage && typeof tg.CloudStorage.getItem === 'function');

    function loadStateLocal(){ const raw = localStorage.getItem(KEY); return raw ? JSON.parse(raw) : null; }
    function saveStateLocal(state){ localStorage.setItem(KEY, JSON.stringify(state)); }

    function loadStateCloud(){
      return new Promise((resolve) => {
        tg.CloudStorage.getItem(KEY, (err, value) => {
          if (err || !value) return resolve(null);
          try{ resolve(JSON.parse(value)); } catch { resolve(null); }
        });
      });
    }
    function saveStateCloud(state){
      return new Promise((resolve) => {
        tg.CloudStorage.setItem(KEY, JSON.stringify(state), () => resolve(true));
      });
    }
    async function persist(){ if (canCloud) await saveStateCloud(state); else saveStateLocal(state); }

    // XP
    function xpNeeded(level){ return Math.round(100 + (level - 1) * 35); }
    function addXP(amount){
      state.xp += amount;
      let leveled = false;
      while (state.xp >= xpNeeded(state.level)){
        state.xp -= xpNeeded(state.level);
        state.level += 1;
        leveled = true;
      }
      if (leveled){
        tg?.HapticFeedback?.notificationOccurred?.("success");
        toast(`üéâ –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${state.level}!`);
        addLog("üéâ", `–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å ${state.level}`);
      }
    }

    // Shop items
    const SHOP = [
      { id:"collar", ico:"üßø", title:"–û—à–µ–π–Ω–∏–∫", price:25, desc:"–ë–æ–Ω—É—Å: –ø—Ä–æ–≥—É–ª–∫–∞ –¥–∞—ë—Ç +2 XP", bonus:{ walk_xp:+2 } },
      { id:"ball",   ico:"‚öΩ", title:"–ú—è—á–∏–∫",   price:35, desc:"–ë–æ–Ω—É—Å: —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–∞—ë—Ç +3 —Ä–∞–¥–æ—Å—Ç–∏", bonus:{ train_happy:+3 } },
      { id:"bowl",   ico:"ü•£", title:"–ú–∏—Å–∫–∞",   price:30, desc:"–ë–æ–Ω—É—Å: –∫–æ—Ä–º—ë–∂–∫–∞ –¥–∞—ë—Ç +5 —Å—ã—Ç–æ—Å—Ç–∏", bonus:{ feed_hunger:+5 } },
      { id:"brush",  ico:"ü™Æ", title:"–©—ë—Ç–∫–∞",   price:28, desc:"–ë–æ–Ω—É—Å: –≤—ã—á—ë—Å—ã–≤–∞–Ω–∏–µ –¥–∞—ë—Ç +3 —á–∏—Å—Ç–æ—Ç—ã", bonus:{ groom_clean:+3 } },
      { id:"blanket",ico:"üß∏", title:"–ü–ª–µ–¥",    price:20, desc:"–ë–æ–Ω—É—Å: –æ—Ç–¥—ã—Ö –¥–∞—ë—Ç +4 —ç–Ω–µ—Ä–≥–∏–∏", bonus:{ rest_energy:+4 } },
    ];
    function getEquipped(){ return state.equipped ? (SHOP.find(i=>i.id===state.equipped) || null) : null; }

    function applyBonus(actionKey, base){
      const eq = getEquipped();
      if (!eq) return base;
      const b = eq.bonus || {};
      if (actionKey === "walk"  && b.walk_xp)      base.xp += b.walk_xp;
      if (actionKey === "train" && b.train_happy)  base.delta.happy += b.train_happy;
      if (actionKey === "feed"  && b.feed_hunger)  base.delta.hunger += b.feed_hunger;
      if (actionKey === "groom" && b.groom_clean)  base.delta.clean += b.groom_clean;
      if (actionKey === "rest"  && b.rest_energy)  base.delta.energy += b.rest_energy;
      return base;
    }

    // Daily quests
    const QUEST_POOL = [
      { id:"q_feed2",  title:"–°—ã—Ç–Ω—ã–π –¥–µ–Ω—å",     desc:"–ü–æ–∫–æ—Ä–º–∏ 2 —Ä–∞–∑–∞", type:"feed",  need:2,  reward:{ coins:6, xp:10 } },
      { id:"q_walk2",  title:"–°–≤–µ–∂–∏–π –≤–æ–∑–¥—É—Ö",   desc:"–ü–æ–≥—É–ª—è–π 2 —Ä–∞–∑–∞", type:"walk",  need:2,  reward:{ coins:8, xp:12 } },
      { id:"q_train1", title:"–î—Ä–µ—Å—Å—É—Ä–∞",        desc:"–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ 1 —Ä–∞–∑", type:"train", need:1, reward:{ coins:7, xp:14 } },
      { id:"q_groom1", title:"–ö—Ä–∞—Å–∞–≤—á–∏–∫",       desc:"–í—ã—á–µ—Å–∞—Ç—å 1 —Ä–∞–∑", type:"groom", need:1, reward:{ coins:6, xp:10 } },
      { id:"q_pet5",   title:"–õ—é–±–æ–≤—å",          desc:"–ü–æ–≥–ª–∞–¥—å 5 —Ä–∞–∑",  type:"pet",   need:5,  reward:{ coins:5, xp:10 } },
      { id:"q_rest1",  title:"–†–µ–∂–∏–º —Å–Ω–∞",       desc:"–û—Ç–¥–æ—Ö–Ω—É—Ç—å 1 —Ä–∞–∑", type:"rest", need:1,  reward:{ coins:4, xp:8 } },
    ];

    function todayKey(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function pickDaily(){
      // 3 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏—è
      const pool = [...QUEST_POOL];
      const chosen = [];
      while (chosen.length < 3 && pool.length){
        const idx = Math.floor(Math.random()*pool.length);
        chosen.push(pool.splice(idx,1)[0]);
      }
      return chosen.map(q => ({
        id:q.id, title:q.title, desc:q.desc, type:q.type, need:q.need,
        reward:q.reward, claimed:false
      }));
    }

    function ensureDaily(){
      const tk = todayKey();
      if (!state.daily || state.daily.dayKey !== tk){
        state.daily = { dayKey: tk, quests: pickDaily() };
        addLog("üìÖ", "–ù–æ–≤—ã–µ –µ–∂–µ–¥–Ω–µ–≤–∫–∏!");
      }
    }

    function questProgress(q){
      // –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö —Å—á—ë—Ç—á–∏–∫–æ–≤
      const c = state.dailyCounts || {};
      return Math.min(q.need, (c[q.type] || 0));
    }

    function renderDaily(){
      ensureDaily();
      const list = el("dailyList");
      const tk = state.daily.dayKey;
      el("dailyInfo").textContent = `–°–µ–≥–æ–¥–Ω—è: ${tk}`;

      list.innerHTML = "";
      state.daily.quests.forEach((q, idx) => {
        const prog = questProgress(q);
        const ready = prog >= q.need && !q.claimed;

        const div = document.createElement("div");
        div.className = "quest";
        div.innerHTML = `
          <div class="q-left">
            <div class="q-title">üéØ ${q.title}</div>
            <div class="q-desc">${q.desc} ‚Ä¢ –ù–∞–≥—Ä–∞–¥–∞: ü™ô${q.reward.coins} + XP${q.reward.xp}</div>
          </div>
          <div class="q-right">
            <div class="q-progress">${prog}/${q.need}</div>
            <button class="q-claim" ${ready ? "" : "disabled"} data-i="${idx}">
              ${q.claimed ? "–ü–æ–ª—É—á–µ–Ω–æ" : (ready ? "–ó–∞–±—Ä–∞—Ç—å" : "–ñ–¥—ë—Ç")}
            </button>
          </div>
        `;
        list.appendChild(div);
      });

      list.querySelectorAll("button[data-i]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const i = parseInt(e.currentTarget.getAttribute("data-i"),10);
          await claimQuest(i);
        });
      });
    }

    async function claimQuest(i){
      const q = state.daily.quests[i];
      if (!q || q.claimed) return;
      const prog = questProgress(q);
      if (prog < q.need) return;

      q.claimed = true;
      state.coins += q.reward.coins;
      addXP(q.reward.xp);
      addLog("üéÅ", `–ï–∂–µ–¥–Ω–µ–≤–∫–∞: ${q.title} (+ü™ô${q.reward.coins}, +XP${q.reward.xp})`);
      tg?.HapticFeedback?.notificationOccurred?.("success");
      toast("–ù–∞–≥—Ä–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞ üéÅ");

      checkAchievements();
      await persist();
      render();
    }

    // Achievements
    const ACHS = [
      { id:"first_action", ico:"üèÅ", title:"–ü–µ—Ä–≤—ã–π —à–∞–≥", desc:"–°–¥–µ–ª–∞–π –ª—é–±–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ 1 —Ä–∞–∑" },
      { id:"pet_10", ico:"üíõ", title:"–õ–∞—Å–∫–æ–≤—ã–π", desc:"–ü–æ–≥–ª–∞–¥—å –ø—ë—Å–µ–ª—è 10 —Ä–∞–∑" },
      { id:"coins_50", ico:"ü™ô", title:"–ö–æ–ø–∏–ª–∫–∞", desc:"–ù–∞–∫–æ–ø–∏ 50 –º–æ–Ω–µ—Ç" },
      { id:"buy_1", ico:"üõçÔ∏è", title:"–ü–µ—Ä–≤–∞—è –ø–æ–∫—É–ø–∫–∞", desc:"–ö—É–ø–∏ 1 –ø—Ä–µ–¥–º–µ—Ç" },
      { id:"equip_1", ico:"üéΩ", title:"–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞", desc:"–≠–∫–∏–ø–∏—Ä—É–π –ø—Ä–µ–¥–º–µ—Ç" },
      { id:"daily_1", ico:"üìÖ", title:"–î–µ–π–ª–∏–∫–∏", desc:"–ó–∞–±–µ—Ä–∏ 1 –µ–∂–µ–¥–Ω–µ–≤–∫—É" },
      { id:"level_5", ico:"‚≠ê", title:"–ü—è—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å", desc:"–î–æ—Å—Ç–∏–≥–Ω–∏ —É—Ä–æ–≤–Ω—è 5" },
      { id:"full_happy", ico:"üòÅ", title:"–°—á–∞—Å—Ç–ª–∏–≤—á–∏–∫", desc:"–ü–æ–¥–Ω–∏–º–∏ —Ä–∞–¥–æ—Å—Ç—å –¥–æ 100%" },
    ];
    function unlock(id){
      if (state.unlocked[id]) return;
      state.unlocked[id] = true;
      tg?.HapticFeedback?.notificationOccurred?.("success");
      toast("üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!");
      addLog("üèÜ", `–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${ACHS.find(a=>a.id===id)?.title || id}`);
    }
    function checkAchievements(){
      const c = state.counts;
      const s = state.stats;
      const anyAction = c.feed + c.walk + c.groom + c.train + c.rest + c.treat + c.pet;
      if (anyAction >= 1) unlock("first_action");
      if (c.pet >= 10) unlock("pet_10");
      if (state.coins >= 50) unlock("coins_50");
      if (Object.keys(state.owned || {}).length >= 1) unlock("buy_1");
      if (state.equipped) unlock("equip_1");
      if (state.daily && state.daily.quests && state.daily.quests.some(x=>x.claimed)) unlock("daily_1");
      if (state.level >= 5) unlock("level_5");
      if (Math.round(s.happy) >= 100) unlock("full_happy");
    }
    function renderAchievements(){
      const grid = el("achGrid");
      grid.innerHTML = "";
      ACHS.forEach(a => {
        const div = document.createElement("div");
        div.className = "ach" + (state.unlocked[a.id] ? " unlocked" : "");
        div.innerHTML = `
          <div class="ach-ico">${a.ico}</div>
          <div class="ach-body">
            <div class="ach-title">${a.title}</div>
            <div class="ach-desc">${a.desc}</div>
          </div>
        `;
        grid.appendChild(div);
      });
    }

    // State
    const DEFAULT = {
      dogName: "–ì–æ–ª–¥–µ–Ω",
      stats: { hunger: 78, happy: 70, clean: 65, energy: 72 },
      history: [],
      lastTick: now(),
      level: 1,
      xp: 0,
      coins: 0,
      owned: {},
      equipped: null,
      unlocked: {},
      counts: { feed:0, walk:0, groom:0, train:0, rest:0, treat:0, pet:0 },
      reminders: { enabled:false, feed_h:6, walk_h:8, quiet_from:0, quiet_to:7 },
      daily: null,
      dailyCounts: null
    };
    let state = structuredClone(DEFAULT);

    function addLog(emoji, title){
      state.history.unshift({ emoji, title, ts: now() });
      state.history = state.history.slice(0, 80);
    }

    function applyDecay(){
      const t = now();
      const dtMin = Math.max(0, (t - (state.lastTick || t)) / 60000);
      state.lastTick = t;
      state.stats.hunger = clamp(state.stats.hunger - dtMin * 0.06);
      state.stats.happy  = clamp(state.stats.happy  - dtMin * 0.04);
      state.stats.clean  = clamp(state.stats.clean  - dtMin * 0.03);
      state.stats.energy = clamp(state.stats.energy - dtMin * 0.05);
    }

    const ACTIONS = {
      feed:  { emoji:"üçó", title:"–ü–æ–∫–æ—Ä–º–∏–ª",   xp:12, coins:3, delta:{ hunger:+25, happy:+6,  clean:0,   energy:0 } },
      walk:  { emoji:"ü¶Æ", title:"–ü–æ–≥—É–ª—è–ª",    xp:14, coins:4, delta:{ hunger:-3,  happy:+18, clean:-2,  energy:-10 } },
      groom: { emoji:"üßº", title:"–í—ã—á–µ—Å–∞–ª",    xp:10, coins:2, delta:{ hunger:0,   happy:+4,  clean:+25, energy:-2 } },
      train: { emoji:"üéæ", title:"–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", xp:18, coins:5, delta:{ hunger:-4,  happy:+10, clean:-1,  energy:-18 } },
      rest:  { emoji:"üò¥", title:"–û—Ç–¥–æ—Ö–Ω—É–ª",   xp:8,  coins:1, delta:{ hunger:-1,  happy:+2,  clean:0,   energy:+28 } },
      treat: { emoji:"ü¶¥", title:"–õ–∞–∫–æ–º—Å—Ç–≤–æ",  xp:9,  coins:2, delta:{ hunger:+8,  happy:+16, clean:0,   energy:0 } },
    };

    function moodBadges(){
      const s = state.stats;
      const badges = [];
      if (s.hunger < 25) badges.push("üçó –≥–æ–ª–æ–¥");
      if (s.energy < 25) badges.push("‚ö° —É—Å—Ç–∞–ª");
      if (s.clean < 25)  badges.push("üßº –≥—Ä—è–∑–Ω—ã–π");
      if (s.happy < 25)  badges.push("üíõ –≥—Ä—É—Å—Ç–∏—Ç");
      if (!badges.length && s.happy > 85 && s.hunger > 60) badges.push("‚ú® –∫–∞–π—Ñ—É–µ—Ç");
      return badges.slice(0,3);
    }

    function moodText(){
      const s = state.stats;
      const minStat = Math.min(s.hunger, s.happy, s.clean, s.energy);
      if (minStat < 15) return "–ü–ª–æ—Ö–æ‚Ä¶ —Å—Ä–æ—á–Ω–æ –Ω—É–∂–µ–Ω —É—Ö–æ–¥ üò≠";
      if (s.hunger < 25) return "–ì–æ–ª–æ–¥–Ω–µ–Ω—å–∫–∏–π‚Ä¶ –ø–æ–∫–æ—Ä–º–∏ –º–µ–Ω—è üçó";
      if (s.energy < 25) return "–£—Å—Ç–∞–ª‚Ä¶ —Ö–æ—á—É –æ—Ç–¥—ã—Ö–∞—Ç—å üò¥";
      if (s.clean < 25) return "–Ø –≥—Ä—è–∑–Ω—ã–π‚Ä¶ –≤—ã—á–µ—à–∏ –º–µ–Ω—è üßº";
      if (s.happy > 85 && s.hunger > 60) return "–°—á–∞—Å—Ç–ª–∏–≤—ã–π –ø—ë—Å! üíõ";
      return "–ù–æ—Ä–º–∞–ª—å–Ω–æ —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç üôÇ";
    }

    function updateHints(){
      const eq = getEquipped();
      const mk = (k) => {
        const a0 = ACTIONS[k];
        const a = applyBonus(k, { delta: structuredClone(a0.delta), xp: a0.xp, coins: a0.coins });
        const parts = [];
        if (a.delta.hunger) parts.push(`–°—ã—Ç–æ—Å—Ç—å ${a.delta.hunger>0?"+":""}${a.delta.hunger}`);
        if (a.delta.happy)  parts.push(`–†–∞–¥–æ—Å—Ç—å ${a.delta.happy>0?"+":""}${a.delta.happy}`);
        if (a.delta.clean)  parts.push(`–ß–∏—Å—Ç–æ—Ç–∞ ${a.delta.clean>0?"+":""}${a.delta.clean}`);
        if (a.delta.energy) parts.push(`–≠–Ω–µ—Ä–≥–∏—è ${a.delta.energy>0?"+":""}${a.delta.energy}`);
        return `${parts.join(" ‚Ä¢ ")} ‚Ä¢ XP +${a.xp} ‚Ä¢ ü™ô +${a.coins}` + (eq ? " (—Å –±–æ–Ω—É—Å–æ–º)" : "");
      };
      el("hint_feed").textContent  = mk("feed");
      el("hint_walk").textContent  = mk("walk");
      el("hint_groom").textContent = mk("groom");
      el("hint_train").textContent = mk("train");
      el("hint_rest").textContent  = mk("rest");
      el("hint_treat").textContent = mk("treat");
    }

    function renderShop(){
      const grid = el("shopGrid");
      grid.innerHTML = "";
      const eq = getEquipped();
      el("equipInfo").textContent = "–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ: " + (eq ? `${eq.ico} ${eq.title}` : "‚Äî");

      SHOP.forEach(item => {
        const owned = !!state.owned[item.id];
        const equipped = state.equipped === item.id;
        const btnText = equipped ? "–°–Ω—è—Ç—å" : (owned ? "–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å" : `–ö—É–ø–∏—Ç—å`);
        const btnClass = owned ? "btn-buy secondary" : "btn-buy";
        const priceText = owned ? (equipped ? "–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ" : "–ö—É–ø–ª–µ–Ω–æ") : `–¶–µ–Ω–∞: ü™ô ${item.price}`;

        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div class="item-ico">${item.ico}</div>
          <div class="item-body">
            <div class="item-title">${item.title}</div>
            <div class="item-desc">${item.desc}</div>
            <div class="item-row">
              <div class="price">${priceText}</div>
              <button class="${btnClass}" data-id="${item.id}">${btnText}</button>
            </div>
          </div>
        `;
        grid.appendChild(div);
      });

      grid.querySelectorAll("button[data-id]").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const id = e.currentTarget.getAttribute("data-id");
          await shopClick(id);
        });
      });
    }

    async function shopClick(id){
      const item = SHOP.find(i=>i.id===id);
      if (!item) return;

      const owned = !!state.owned[id];
      const equipped = state.equipped === id;

      if (!owned){
        if (state.coins < item.price){
          toast("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–æ–Ω–µ—Ç ü™ô");
          tg?.HapticFeedback?.notificationOccurred?.("error");
          return;
        }
        state.coins -= item.price;
        state.owned[id] = true;
        addLog("üõçÔ∏è", `–ö—É–ø–∏–ª: ${item.title}`);
        toast(`–ö—É–ø–ª–µ–Ω–æ: ${item.ico} ${item.title}`);
      } else {
        if (equipped){
          state.equipped = null;
          addLog("üéΩ", `–°–Ω—è–ª: ${item.title}`);
          toast("–°–Ω—è—Ç–æ ‚úÖ");
        } else {
          state.equipped = id;
          addLog("üéΩ", `–≠–∫–∏–ø–∏—Ä–æ–≤–∞–ª: ${item.title}`);
          toast(`–≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ: ${item.ico}`);
        }
      }

      checkAchievements();
      await persist();
      render();
    }

    function ensureDailyCounts(){
      if (!state.dailyCounts || state.dailyCounts.dayKey !== todayKey()){
        state.dailyCounts = { dayKey: todayKey(), feed:0, walk:0, groom:0, train:0, rest:0, treat:0, pet:0 };
      }
    }

    function render(){
      const s = state.stats;

      const setBar = (name, val) => {
        el('v_' + name).textContent = Math.round(val) + "%";
        el('b_' + name).style.width = clamp(val) + "%";
      };
      setBar('hunger', s.hunger);
      setBar('happy', s.happy);
      setBar('clean', s.clean);
      setBar('energy', s.energy);

      const who = tg?.initDataUnsafe?.user;
      const uname = who?.first_name ? `${who.first_name}${who.username ? " @" + who.username : ""}` : "–≤ Telegram";
      el('sub').textContent = `–ü–∏—Ç–æ–º–µ—Ü: ${state.dogName} ‚Ä¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${uname}`;
      el('petTitle').textContent = state.dogName;

      el('saveMode').textContent = canCloud ? "–°–æ—Ö—Ä–∞–Ω—è—é –≤ Telegram" : "–°–æ—Ö—Ä–∞–Ω—è—é –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ";
      el('chip').textContent = canCloud ? "v2.1 ‚Ä¢ Telegram save" : "v2.1 ‚Ä¢ device save";
      el('coinChip').textContent = `ü™ô ${state.coins}`;

      const need = xpNeeded(state.level);
      el("lvl").textContent = `–£—Ä–æ–≤–µ–Ω—å ${state.level}`;
      el("xptext").textContent = `${Math.round(state.xp)} / ${need} XP`;
      el("xpfill").style.width = clamp((state.xp / need) * 100) + "%";

      // dog always üê∂
      el("petDog").textContent = "üê∂";
      const eq = getEquipped();
      el("equipEmoji").textContent = eq ? eq.ico : "";

      // mood
      el("moodText").textContent = `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${moodText()}`;
      const badges = moodBadges();
      const wrap = el("moodBadges");
      wrap.innerHTML = "";
      badges.forEach(b => {
        const span = document.createElement("span");
        span.className = "badge";
        span.textContent = b;
        wrap.appendChild(span);
      });

      ensureDaily();
      ensureDailyCounts();
      renderDaily();
      updateHints();
      renderShop();
      renderAchievements();

      const list = el('history');
      list.innerHTML = "";
      if (!state.history.length){
        list.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:6px 2px;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É üôÇ</div>`;
      } else {
        state.history.forEach(item => {
          const row = document.createElement('div');
          row.className = 'log';
          row.innerHTML = `
            <div class="log-left">
              <div class="log-emoji">${item.emoji}</div>
              <div class="log-text">
                <div class="log-title">${item.title}</div>
                <div class="log-time">${new Date(item.ts).toLocaleString(undefined, { hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit' })}</div>
              </div>
            </div>
          `;
          list.appendChild(row);
        });
      }
    }

    window.doAction = async function(key){
      applyDecay();
      ensureDaily();
      ensureDailyCounts();

      const a0 = ACTIONS[key];
      if (!a0) return;

      const a = applyBonus(key, { delta: structuredClone(a0.delta), xp: a0.xp, coins: a0.coins });

      state.stats.hunger = clamp(state.stats.hunger + (a.delta.hunger || 0));
      state.stats.happy  = clamp(state.stats.happy  + (a.delta.happy  || 0));
      state.stats.clean  = clamp(state.stats.clean  + (a.delta.clean  || 0));
      state.stats.energy = clamp(state.stats.energy + (a.delta.energy || 0));

      state.counts[key] = (state.counts[key] || 0) + 1;

      // daily progress
      state.dailyCounts[key] = (state.dailyCounts[key] || 0) + 1;

      state.coins += a.coins;
      addLog(a0.emoji, a0.title);
      addXP(a.xp);

      tg?.HapticFeedback?.impactOccurred?.("light");
      toast(`${a0.emoji} ${a0.title}! +${a.xp}XP ‚Ä¢ ü™ô+${a.coins}`);

      checkAchievements();
      await persist();
      render();
    }

    window.petDog = async function(){
      applyDecay();
      ensureDaily();
      ensureDailyCounts();

      state.stats.happy = clamp(state.stats.happy + 3);
      state.stats.energy = clamp(state.stats.energy + 1);

      state.counts.pet += 1;

      // daily progress
      state.dailyCounts.pet = (state.dailyCounts.pet || 0) + 1;

      state.coins += 1;
      addLog("üê∂", "–ü–æ–≥–ª–∞–¥–∏–ª –ø—ë—Å–µ–ª—è");
      addXP(4);

      const pet = el('petDog');
      pet.classList.remove('petted');
      void pet.offsetWidth;
      pet.classList.add('petted');

      const hearts = el('hearts');
      hearts.classList.add('show');
      setTimeout(()=>hearts.classList.remove('show'), 750);

      tg?.HapticFeedback?.impactOccurred?.("medium");
      toast("üíõ –ï–º—É –ø—Ä–∏—è—Ç–Ω–æ! +4XP ‚Ä¢ ü™ô+1");

      checkAchievements();
      await persist();
      render();
    }

    window.renameDog = async function(){
      const name = prompt("–ö–∞–∫ –Ω–∞–∑–æ–≤—ë–º –ø—ë—Å–µ–ª—è? üòÑ", state.dogName);
      if (!name) return;
      state.dogName = name.slice(0, 18);
      addLog("‚úèÔ∏è", `–ò–º—è: ${state.dogName}`);
      await persist();
      render();
      toast("–ò–º—è –æ–±–Ω–æ–≤–∏–ª ‚úÖ");
    }

    // Reminders -> bot (bot.py —É —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å)
    window.openReminders = async function(){
      const r = state.reminders || { enabled:false, feed_h:6, walk_h:8, quiet_from:0, quiet_to:7 };

      const enabled = confirm("–í–∫–ª—é—á–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏? (–û–ö=–≤–∫–ª—é—á–∏—Ç—å, –û—Ç–º–µ–Ω–∞=–≤—ã–∫–ª—é—á–∏—Ç—å)");
      r.enabled = enabled;

      if (enabled){
        const feed = prompt("–ö–∞–∂–¥—ã–µ —Å–∫–æ–ª—å–∫–æ –ß–ê–°–û–í –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –ø–æ–∫–æ—Ä–º–∏—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä 6)", String(r.feed_h ?? 6));
        const walk = prompt("–ö–∞–∂–¥—ã–µ —Å–∫–æ–ª—å–∫–æ –ß–ê–°–û–í –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –ø–æ–≥—É–ª—è—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä 8)", String(r.walk_h ?? 8));
        const qf = prompt("–¢–∏—Ö–∏–µ —á–∞—Å—ã –° (0-23). –ù–∞–ø—Ä–∏–º–µ—Ä 0", String(r.quiet_from ?? 0));
        const qt = prompt("–¢–∏—Ö–∏–µ —á–∞—Å—ã –î–û (0-23). –ù–∞–ø—Ä–∏–º–µ—Ä 7", String(r.quiet_to ?? 7));

        r.feed_h = Math.max(1, Math.min(24, parseInt(feed||"6",10) || 6));
        r.walk_h = Math.max(1, Math.min(24, parseInt(walk||"8",10) || 8));
        r.quiet_from = Math.max(0, Math.min(23, parseInt(qf||"0",10) || 0));
        r.quiet_to   = Math.max(0, Math.min(23, parseInt(qt||"7",10) || 7));
      }

      state.reminders = r;
      addLog("‚è∞", r.enabled ? `–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏ –≤–∫–ª—é—á–µ–Ω—ã (–µ–¥–∞ ${r.feed_h}—á, –ø—Ä–æ–≥—É–ª–∫–∞ ${r.walk_h}—á)` : "–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∏ –≤—ã–∫–ª—é—á–µ–Ω—ã");

      try{
        tg?.sendData?.(JSON.stringify({ type:"reminders", reminders: r }));
        toast("–û—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç—É ‚úÖ");
      }catch{
        toast("–ù–µ —Å–º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–æ—Ç—É üòï");
      }

      await persist();
      render();
    }

    window.resetAll = async function(){
      if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë? (—Å—Ç–∞—Ç—ã/XP/–º–æ–Ω–µ—Ç—ã/–º–∞–≥–∞–∑–∏–Ω/–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è/–¥–µ–π–ª–∏–∫–∏)")) return;
      state = structuredClone(DEFAULT);
      await persist();
      render();
      toast("–°–±—Ä–æ—Å–∏–ª üóë");
    }

    window.share = function(){
      const s = state.stats;
      const eq = getEquipped();
      const msg =
`üê∂ ${state.dogName}
‚≠ê –£—Ä–æ–≤–µ–Ω—å: ${state.level}
ü™ô –ú–æ–Ω–µ—Ç—ã: ${state.coins}
üéΩ –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞: ${eq ? eq.title : "‚Äî"}
üçó –°—ã—Ç–æ—Å—Ç—å: ${Math.round(s.hunger)}%
üòä –†–∞–¥–æ—Å—Ç—å: ${Math.round(s.happy)}%
üßº –ß–∏—Å—Ç–æ—Ç–∞: ${Math.round(s.clean)}%
‚ö° –≠–Ω–µ—Ä–≥–∏—è: ${Math.round(s.energy)}%`;
      tg?.showPopup?.({ title: "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è", message: msg, buttons: [{type:"ok"}] }) || alert(msg);
    }

    async function boot(){
      let loaded = null;
      if (canCloud) loaded = await loadStateCloud();
      if (!loaded) loaded = loadStateLocal();

      state = loaded ? loaded : structuredClone(DEFAULT);

      // –º–∏–≥—Ä–∞—Ü–∏—è
      state.level ??= 1;
      state.xp ??= 0;
      state.coins ??= 0;
      state.owned ??= {};
      state.equipped ??= null;
      state.unlocked ??= {};
      state.counts ??= { feed:0, walk:0, groom:0, train:0, rest:0, treat:0, pet:0 };
      state.reminders ??= { enabled:false, feed_h:6, walk_h:8, quiet_from:0, quiet_to:7 };
      state.daily ??= null;
      state.dailyCounts ??= null;

      applyDecay();
      ensureDaily();
      ensureDailyCounts();
      checkAchievements();

      await persist();
      render();

      setInterval(async () => {
        applyDecay();
        ensureDaily();
        ensureDailyCounts();
        checkAchievements();
        await persist();
        render();
      }, 15000);
    }

    boot();
  </script>
</body>
</html>
