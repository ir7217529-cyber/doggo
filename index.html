<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Golden Care</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg1:#0b0b10;
      --bg2:#12121a;
      --card: rgba(31,31,38,0.92);
      --stroke: rgba(255,255,255,0.08);
      --text:#ffffff;
      --muted:#a7a7b3;
      --radius:16px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(900px 500px at 20% 10%, #1b1b28 0%, transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, #23233a 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* –õ–∞–ø–∫–∏ –Ω–∞ —Ñ–æ–Ω–µ */
    .bg{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:1;
    }
    .paw{
      position:absolute;
      right:-40px;
      top: 22%;
      font-size: 22px;
      opacity:0.12;
      animation: paw-drift 10s linear infinite;
    }
    .paw:nth-child(2){ top: 38%; animation-duration: 12s; font-size: 20px; opacity:0.10; }
    .paw:nth-child(3){ top: 58%; animation-duration: 14s; font-size: 24px; opacity:0.11; }
    .paw:nth-child(4){ top: 74%; animation-duration: 11s; font-size: 21px; opacity:0.09; }
    @keyframes paw-drift{
      0%   { transform: translateX(0) rotate(-10deg); }
      100% { transform: translateX(-120vw) rotate(10deg); }
    }

    .wrap{
      max-width:720px;
      margin:0 auto;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      position:relative;
      z-index:2;
    }

    /* –®–∞–ø–∫–∞ (—Ñ–∏–∫—Å —Å—ä–µ–∑–∂–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞) */
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-top:8px;
    }
    .head-left{
      flex:1;
      min-width:0;
    }
    h1{
      font-size:22px;
      margin:0;
      line-height:1.1;
    }
    .sub{
      margin-top:4px;
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip{
      flex-shrink:0;
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: rgba(0,0,0,0.18);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    .card{
      margin-top:12px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    /* –ü–∏—Ç–æ–º–µ—Ü */
    .pet-card{
      position:relative;
      padding: 12px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,0.12);
      overflow:hidden;
    }
    .pet-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .pet-title{
      font-weight:900;
      font-size:14px;
      color:#fff;
    }
    .pet-hint{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }

    /* XP / Level */
    .level-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
    }
    .lvl{
      font-weight:900;
      font-size:13px;
      color:#fff;
      white-space:nowrap;
    }
    .xptext{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .xpbar{
      width:100%;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.08);
      margin-top:8px;
    }
    .xpfill{
      height:100%;
      width:30%;
      border-radius:999px;
      background: rgba(255,255,255,0.85);
      transition: width 220ms ease;
    }

    .pet-zone{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 6px 0 2px;
    }
    .pet-btn{
      border: 0;
      background: transparent;
      cursor: pointer;
      padding: 6px;
      border-radius: 999px;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }
    .pet{
      font-size: 88px;
      line-height: 1;
      filter: drop-shadow(0 14px 30px rgba(0,0,0,0.55));
      transform-origin: 50% 80%;
      animation: pet-idle 2.8s ease-in-out infinite;
      user-select:none;
    }
    @keyframes pet-idle{
      0%,100% { transform: translateY(0) rotate(-1.5deg); }
      50%     { transform: translateY(-6px) rotate(1.5deg); }
    }
    .pet.petted{
      animation: pet-pet 520ms ease-out 1;
    }
    @keyframes pet-pet{
      0%   { transform: translateY(0) scale(1) rotate(0deg); }
      35%  { transform: translateY(-10px) scale(1.05) rotate(4deg); }
      70%  { transform: translateY(0) scale(0.98) rotate(-4deg); }
      100% { transform: translateY(0) scale(1) rotate(0deg); }
    }

    .hearts{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
    }
    .hearts.show{ opacity:1; }
    .heart{
      position:absolute;
      left:50%;
      top:55%;
      transform: translate(-50%,-50%);
      font-size:18px;
      opacity:0;
      animation: heart-pop 700ms ease-out forwards;
    }
    .heart:nth-child(1){ margin-left:-26px; animation-delay: 0ms; }
    .heart:nth-child(2){ margin-left: 0px;  animation-delay: 60ms; }
    .heart:nth-child(3){ margin-left: 26px; animation-delay: 120ms; }
    @keyframes heart-pop{
      0%   { opacity:0; transform: translate(-50%,-50%) scale(0.7); }
      30%  { opacity:0.9; transform: translate(-50%,-70%) scale(1.1); }
      100% { opacity:0; transform: translate(-50%,-120%) scale(1.0); }
    }

    /* –°—Ç–∞—Ç—ã */
    .stats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 420px){
      .stats{ grid-template-columns: 1fr; }
    }
    .stat{
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 10px;
      background: rgba(0,0,0,0.10);
    }
    .stat-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      font-size:12.5px;
    }
    .stat-name{
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
    }
    .stat-val{
      font-variant-numeric: tabular-nums;
      color: #fff;
      opacity:0.9;
    }
    .bar{
      width:100%;
      height:10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .fill{
      height:100%;
      width:50%;
      border-radius: 999px;
      background: rgba(255,255,255,0.85);
      transition: width 220ms ease;
    }

    /* –î–µ–π—Å—Ç–≤–∏—è */
    .actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 360px){
      .actions{ grid-template-columns: 1fr; }
    }
    button.action{
      width:100%;
      border: 1px solid var(--stroke);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(0,0,0,0.18);
      color: var(--text);
      text-align:left;
      cursor:pointer;
      min-height: 58px;
      transition: transform 120ms ease;
    }
    button.action:active{ transform: scale(0.98); }

    /* –í–ê–ñ–ù–û: —Ñ–∏–∫—Å —Å—ä–µ–∑–∂–∞—é—â–∏—Ö –∫–æ–ª–æ–Ω–æ–∫ */
    .a-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .a-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14.5px;
      font-weight:900;
      min-width:0;
      flex:1;
    }
    .a-emoji{
      font-size:20px;
      line-height:1;
      flex-shrink:0;
    }
    .a-text{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .a-plus{
      font-size:20px;
      opacity:0.8;
      flex-shrink:0;
    }

    .a-hint{
      margin-top:6px;
      color:var(--muted);
      font-size:11.5px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .row{
      display:flex;
      gap:10px;
      margin-top:10px;
      flex-wrap:wrap;
    }
    .btn-mini{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.18);
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    .btn-mini:active{ transform: scale(0.98); }

    /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è */
    .ach-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 420px){
      .ach-grid{ grid-template-columns: 1fr; }
    }
    .ach{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.10);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      opacity:0.6;
    }
    .ach.unlocked{ opacity:1; }
    .ach-ico{ font-size:20px; line-height:1; margin-top:2px; }
    .ach-body{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .ach-title{ font-size:13.5px; font-weight:900; }
    .ach-desc{ font-size:11.5px; color:var(--muted); }

    /* –ò—Å—Ç–æ—Ä–∏—è */
    .history{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
      max-height: 260px;
      overflow:auto;
      padding-right:2px;
    }
    .log{
      border:1px solid var(--stroke);
      background: rgba(0,0,0,0.10);
      border-radius: 12px;
      padding: 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .log-left{
      display:flex;
      gap:10px;
      align-items:flex-start;
      min-width:0;
    }
    .log-emoji{ font-size:20px; line-height:1; margin-top:1px; flex-shrink:0; }
    .log-text{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .log-title{ font-size:13.5px; font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .log-time{ font-size:11.5px; color:var(--muted); }

    .toast{
      position:fixed;
      left:50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.12);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:12.5px;
      opacity:0;
      pointer-events:none;
      transition: opacity 180ms ease, transform 180ms ease;
      z-index:3;
      backdrop-filter: blur(8px);
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <div class="bg">
    <div class="paw">üêæ</div>
    <div class="paw">üêæ</div>
    <div class="paw">üêæ</div>
    <div class="paw">üêæ</div>
  </div>

  <div class="wrap">
    <header>
      <div class="head-left">
        <h1>Golden Care</h1>
        <div class="sub" id="sub">–ó–∞–≥—Ä—É–∂–∞—é –ø—Ä–æ—Ñ–∏–ª—å‚Ä¶</div>
      </div>
      <div class="chip" id="chip">v1.2 ‚Ä¢ save</div>
    </header>

    <div class="card">
      <!-- –ü—ë—Å + —É—Ä–æ–≤–µ–Ω—å -->
      <div class="pet-card">
        <div class="pet-top">
          <div class="pet-title" id="petTitle">–ü—ë—Å–µ–ª—å</div>
          <div class="pet-hint">–¢–∞–ø–∞–π –ø–æ –Ω–µ–º—É üêæ</div>
        </div>

        <div class="level-row">
          <div class="lvl" id="lvl">–£—Ä–æ–≤–µ–Ω—å 1</div>
          <div class="xptext" id="xptext">0 / 100 XP</div>
        </div>
        <div class="xpbar"><div class="xpfill" id="xpfill"></div></div>

        <div class="pet-zone">
          <button class="pet-btn" onclick="petDog()" aria-label="–ü–æ–≥–ª–∞–¥–∏—Ç—å —Å–æ–±–∞–∫—É">
            <div class="pet" id="petDog">üê∂</div>
          </button>
        </div>

        <div class="hearts" id="hearts">
          <div class="heart">üíõ</div>
          <div class="heart">üíõ</div>
          <div class="heart">üíõ</div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç—ã -->
      <div class="stats">
        <div class="stat">
          <div class="stat-top">
            <div class="stat-name">üçó –°—ã—Ç–æ—Å—Ç—å</div>
            <div class="stat-val" id="v_hunger">‚Äî</div>
          </div>
          <div class="bar"><div class="fill" id="b_hunger"></div></div>
        </div>

        <div class="stat">
          <div class="stat-top">
            <div class="stat-name">üòä –†–∞–¥–æ—Å—Ç—å</div>
            <div class="stat-val" id="v_happy">‚Äî</div>
          </div>
          <div class="bar"><div class="fill" id="b_happy"></div></div>
        </div>

        <div class="stat">
          <div class="stat-top">
            <div class="stat-name">üßº –ß–∏—Å—Ç–æ—Ç–∞</div>
            <div class="stat-val" id="v_clean">‚Äî</div>
          </div>
          <div class="bar"><div class="fill" id="b_clean"></div></div>
        </div>

        <div class="stat">
          <div class="stat-top">
            <div class="stat-name">‚ö° –≠–Ω–µ—Ä–≥–∏—è</div>
            <div class="stat-val" id="v_energy">‚Äî</div>
          </div>
          <div class="bar"><div class="fill" id="b_energy"></div></div>
        </div>
      </div>

      <!-- –î–µ–π—Å—Ç–≤–∏—è -->
      <div class="actions">
        <button class="action" onclick="doAction('feed')">
          <div class="a-top">
            <div class="a-title"><span class="a-emoji">üçó</span><span class="a-text">–ü–æ–∫–æ—Ä–º–∏—Ç—å</span></div>
            <div class="a-plus">Ôºã</div>
          </div>
          <div class="a-hint">–°—ã—Ç–æ—Å—Ç—å +25 ‚Ä¢ –†–∞–¥–æ—Å—Ç—å +6 ‚Ä¢ XP +12</div>
        </button>

        <button class="action" onclick="doAction('walk')">
          <div class="a-top">
            <div class="a-title"><span class="a-emoji">ü¶Æ</span><span class="a-text">–ü–æ–≥—É–ª—è—Ç—å</span></div>
            <div class="a-plus">Ôºã</div>
          </div>
          <div class="a-hint">–†–∞–¥–æ—Å—Ç—å +18 ‚Ä¢ –≠–Ω–µ—Ä–≥–∏—è ‚àí10 ‚Ä¢ XP +14</div>
        </button>

        <button class="action" onclick="doAction('groom')">
          <div class="a-top">
            <div class="a-title"><span class="a-emoji">üßº</span><span class="a-text">–í—ã—á–µ—Å–∞—Ç—å</span></div>
            <div class="a-plus">Ôºã</div>
          </div>
          <div class="a-hint">–ß–∏—Å—Ç–æ—Ç–∞ +25 ‚Ä¢ –†–∞–¥–æ—Å—Ç—å +4 ‚Ä¢ XP +10</div>
        </button>

        <button class="action" onclick="doAction('train')">
          <div class="a-top">
            <div class="a-title"><span class="a-emoji">üéæ</span><span class="a-text">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</span></div>
            <div class="a-plus">Ôºã</div>
          </div>
          <div class="a-hint">–†–∞–¥–æ—Å—Ç—å +10 ‚Ä¢ –≠–Ω–µ—Ä–≥–∏—è ‚àí18 ‚Ä¢ XP +18</div>
        </button>

        <button class="action" onclick="doAction('rest')">
          <div class="a-top">
            <div class="a-title"><span class="a-emoji">üò¥</span><span class="a-text">–û—Ç–¥–æ—Ö–Ω—É—Ç—å</span></div>
            <div class="a-plus">Ôºã</div>
          </div>
          <div class="a-hint">–≠–Ω–µ—Ä–≥–∏—è +28 ‚Ä¢ XP +8</div>
        </button>

        <button class="action" onclick="doAction('treat')">
          <div class="a-top">
            <div class="a-title"><span class="a-emoji">ü¶¥</span><span class="a-text">–õ–∞–∫–æ–º—Å—Ç–≤–æ</span></div>
            <div class="a-plus">Ôºã</div>
          </div>
          <div class="a-hint">–†–∞–¥–æ—Å—Ç—å +16 ‚Ä¢ –°—ã—Ç–æ—Å—Ç—å +8 ‚Ä¢ XP +9</div>
        </button>
      </div>

      <div class="row">
        <button class="btn-mini" onclick="renameDog()">‚úèÔ∏è –ò–º—è</button>
        <button class="btn-mini" onclick="resetAll()">üóë –°–±—Ä–æ—Å</button>
        <button class="btn-mini" onclick="share()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      </div>
    </div>

    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</div>
        <div style="color:var(--muted);font-size:12px;" id="saveMode">‚Äî</div>
      </div>
      <div class="ach-grid" id="achGrid"></div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
        <div style="font-weight:900;">–ò—Å—Ç–æ—Ä–∏—è</div>
        <div style="color:var(--muted);font-size:12px;">–°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è</div>
      </div>
      <div class="history" id="history"></div>
    </div>
  </div>

  <div class="toast" id="toast">OK</div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg) tg.ready();

    // ---------- Helpers ----------
    const clamp = (n, a=0, b=100) => Math.max(a, Math.min(b, n));
    const now = () => Date.now();

    function fmtTime(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString(undefined, { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
      }catch{
        return '';
      }
    }

    const el = (id) => document.getElementById(id);

    function toast(msg){
      const t = el('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1150);
    }

    // ---------- Storage ----------
    const KEY = 'golden_care_state_v1_2';
    const canCloud = !!(tg && tg.CloudStorage && typeof tg.CloudStorage.getItem === 'function');

    function loadStateLocal(){
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : null;
    }
    function saveStateLocal(state){
      localStorage.setItem(KEY, JSON.stringify(state));
    }

    function loadStateCloud(){
      return new Promise((resolve) => {
        tg.CloudStorage.getItem(KEY, (err, value) => {
          if (err || !value) return resolve(null);
          try{ resolve(JSON.parse(value)); } catch { resolve(null); }
        });
      });
    }
    function saveStateCloud(state){
      return new Promise((resolve) => {
        tg.CloudStorage.setItem(KEY, JSON.stringify(state), () => resolve(true));
      });
    }

    async function persist(){
      if (canCloud) await saveStateCloud(state);
      else saveStateLocal(state);
    }

    // ---------- Game / XP ----------
    function xpNeeded(level){
      // –ø–ª–∞–≤–Ω—ã–π —Ä–æ—Å—Ç
      return Math.round(100 + (level - 1) * 35);
    }

    function addXP(amount){
      state.xp += amount;
      let leveled = false;

      while (state.xp >= xpNeeded(state.level)){
        state.xp -= xpNeeded(state.level);
        state.level += 1;
        leveled = true;
      }

      if (leveled){
        tg?.HapticFeedback?.notificationOccurred?.("success");
        toast(`üéâ –ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å: ${state.level}!`);
        addLog("üéâ", `–ù–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å ${state.level}`);
      }
    }

    // ---------- Achievements ----------
    const ACHS = [
      { id:"first_action", ico:"üèÅ", title:"–ü–µ—Ä–≤—ã–π —à–∞–≥", desc:"–°–¥–µ–ª–∞–π –ª—é–±–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ 1 —Ä–∞–∑" },
      { id:"pet_10", ico:"üíõ", title:"–õ–∞—Å–∫–æ–≤—ã–π", desc:"–ü–æ–≥–ª–∞–¥—å –ø—ë—Å–µ–ª—è 10 —Ä–∞–∑" },
      { id:"feed_10", ico:"üçó", title:"–®–µ—Ñ-–ø–æ–≤–∞—Ä", desc:"–ü–æ–∫–æ—Ä–º–∏ 10 —Ä–∞–∑" },
      { id:"walk_10", ico:"ü¶Æ", title:"–ü—Ä–æ–≥—É–ª–æ—á–Ω–∏–∫", desc:"–ü–æ–≥—É–ª—è–π 10 —Ä–∞–∑" },
      { id:"train_10", ico:"üéæ", title:"–¢—Ä–µ–Ω–µ—Ä", desc:"–ü–æ—Ç—Ä–µ–Ω–∏—Ä—É–π—Å—è 10 —Ä–∞–∑" },
      { id:"clean_10", ico:"üßº", title:"–ì—Ä—É–º–∏–Ω–≥-–º–∞—Å—Ç–µ—Ä", desc:"–í—ã—á–µ—Å–∞–π 10 —Ä–∞–∑" },
      { id:"level_5", ico:"‚≠ê", title:"–ü—è—Ç—ã–π —É—Ä–æ–≤–µ–Ω—å", desc:"–î–æ—Å—Ç–∏–≥–Ω–∏ —É—Ä–æ–≤–Ω—è 5" },
      { id:"full_happy", ico:"üòÅ", title:"–°—á–∞—Å—Ç–ª–∏–≤—á–∏–∫", desc:"–ü–æ–¥–Ω–∏–º–∏ —Ä–∞–¥–æ—Å—Ç—å –¥–æ 100%" },
    ];

    function unlock(id){
      if (state.unlocked[id]) return;
      state.unlocked[id] = true;
      tg?.HapticFeedback?.notificationOccurred?.("success");
      toast("üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ!");
      addLog("üèÜ", `–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${ACHS.find(a=>a.id===id)?.title || id}`);
    }

    function checkAchievements(){
      const c = state.counts;
      const s = state.stats;

      const anyAction = c.feed + c.walk + c.groom + c.train + c.rest + c.treat + c.pet;
      if (anyAction >= 1) unlock("first_action");

      if (c.pet >= 10) unlock("pet_10");
      if (c.feed >= 10) unlock("feed_10");
      if (c.walk >= 10) unlock("walk_10");
      if (c.train >= 10) unlock("train_10");
      if (c.groom >= 10) unlock("clean_10");

      if (state.level >= 5) unlock("level_5");
      if (Math.round(s.happy) >= 100) unlock("full_happy");
    }

    function renderAchievements(){
      const grid = el("achGrid");
      grid.innerHTML = "";
      ACHS.forEach(a => {
        const div = document.createElement("div");
        div.className = "ach" + (state.unlocked[a.id] ? " unlocked" : "");
        div.innerHTML = `
          <div class="ach-ico">${a.ico}</div>
          <div class="ach-body">
            <div class="ach-title">${a.title}</div>
            <div class="ach-desc">${a.desc}</div>
          </div>
        `;
        grid.appendChild(div);
      });
    }

    // ---------- State ----------
    const DEFAULT = {
      dogName: "–ì–æ–ª–¥–µ–Ω",
      stats: { hunger: 78, happy: 70, clean: 65, energy: 72 },
      history: [],
      lastTick: now(),
      level: 1,
      xp: 0,
      unlocked: {},
      counts: { feed:0, walk:0, groom:0, train:0, rest:0, treat:0, pet:0 }
    };

    let state = structuredClone(DEFAULT);

    function applyDecay(){
      const t = now();
      const dtMin = Math.max(0, (t - (state.lastTick || t)) / 60000);
      state.lastTick = t;

      state.stats.hunger = clamp(state.stats.hunger - dtMin * 0.9);
      state.stats.happy  = clamp(state.stats.happy  - dtMin * 0.45);
      state.stats.clean  = clamp(state.stats.clean  - dtMin * 0.35);
      state.stats.energy = clamp(state.stats.energy - dtMin * 0.70);
    }

    function addLog(emoji, title){
      state.history.unshift({ emoji, title, ts: now() });
      state.history = state.history.slice(0, 60);
    }

    const ACTIONS = {
      feed:  { emoji:"üçó", title:"–ü–æ–∫–æ—Ä–º–∏–ª",   xp:12, delta:{ hunger:+25, happy:+6,  clean:0,   energy:0 } },
      walk:  { emoji:"ü¶Æ", title:"–ü–æ–≥—É–ª—è–ª",    xp:14, delta:{ hunger:-6,  happy:+18, clean:-3,  energy:-10 } },
      groom: { emoji:"üßº", title:"–í—ã—á–µ—Å–∞–ª",    xp:10, delta:{ hunger:0,   happy:+4,  clean:+25, energy:-3 } },
      train: { emoji:"üéæ", title:"–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞", xp:18, delta:{ hunger:-8,  happy:+10, clean:-2,  energy:-18 } },
      rest:  { emoji:"üò¥", title:"–û—Ç–¥–æ—Ö–Ω—É–ª",   xp:8,  delta:{ hunger:-2,  happy:+2,  clean:0,   energy:+28 } },
      treat: { emoji:"ü¶¥", title:"–õ–∞–∫–æ–º—Å—Ç–≤–æ",  xp:9,  delta:{ hunger:+8,  happy:+16, clean:0,   energy:0 } },
    };

    // ---------- Render ----------
    function render(){
      const s = state.stats;

      const setBar = (name, val) => {
        el('v_' + name).textContent = Math.round(val) + "%";
        el('b_' + name).style.width = clamp(val) + "%";
      };
      setBar('hunger', s.hunger);
      setBar('happy', s.happy);
      setBar('clean', s.clean);
      setBar('energy', s.energy);

      const who = tg?.initDataUnsafe?.user;
      const uname = who?.first_name ? `${who.first_name}${who.username ? " @" + who.username : ""}` : "–≤ Telegram";
      el('sub').textContent = `–ü–∏—Ç–æ–º–µ—Ü: ${state.dogName} ‚Ä¢ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${uname}`;
      el('petTitle').textContent = state.dogName;

      // Save chip
      el('saveMode').textContent = canCloud ? "–°–æ—Ö—Ä–∞–Ω—è—é –≤ Telegram" : "–°–æ—Ö—Ä–∞–Ω—è—é –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ";
      el('chip').textContent = canCloud ? "v1.2 ‚Ä¢ Telegram save" : "v1.2 ‚Ä¢ device save";

      // XP/Level
      el("lvl").textContent = `–£—Ä–æ–≤–µ–Ω—å ${state.level}`;
      const need = xpNeeded(state.level);
      el("xptext").textContent = `${Math.round(state.xp)} / ${need} XP`;
      el("xpfill").style.width = clamp((state.xp / need) * 100) + "%";

      // Achievements
      renderAchievements();

      // History
      const list = el('history');
      list.innerHTML = "";
      if (!state.history.length){
        list.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:6px 2px;">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –ù–∞–∂–º–∏ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É üôÇ</div>`;
      } else {
        state.history.forEach(item => {
          const row = document.createElement('div');
          row.className = 'log';
          row.innerHTML = `
            <div class="log-left">
              <div class="log-emoji">${item.emoji}</div>
              <div class="log-text">
                <div class="log-title">${item.title}</div>
                <div class="log-time">${fmtTime(item.ts)}</div>
              </div>
            </div>
          `;
          list.appendChild(row);
        });
      }
    }

    // ---------- Actions ----------
    window.doAction = async function(key){
      applyDecay();
      const a = ACTIONS[key];
      if (!a) return;

      state.stats.hunger = clamp(state.stats.hunger + (a.delta.hunger || 0));
      state.stats.happy  = clamp(state.stats.happy  + (a.delta.happy  || 0));
      state.stats.clean  = clamp(state.stats.clean  + (a.delta.clean  || 0));
      state.stats.energy = clamp(state.stats.energy + (a.delta.energy || 0));

      state.counts[key] = (state.counts[key] || 0) + 1;

      addLog(a.emoji, a.title);
      addXP(a.xp);

      tg?.HapticFeedback?.impactOccurred?.("light");

      if (state.stats.hunger < 15) toast("–û–Ω –≥–æ–ª–æ–¥–Ω—ã–π üò≠");
      else if (state.stats.energy < 15) toast("–û–Ω —É—Å—Ç–∞–ª üò¥");
      else toast(`${a.emoji} ${a.title}! +${a.xp}XP`);

      checkAchievements();
      await persist();
      render();
    }

    // –ü–æ–≥–ª–∞–¥–∏—Ç—å
    window.petDog = async function(){
      applyDecay();

      state.stats.happy = clamp(state.stats.happy + 3);
      state.stats.energy = clamp(state.stats.energy + 1);

      state.counts.pet += 1;

      addLog("üê∂", "–ü–æ–≥–ª–∞–¥–∏–ª –ø—ë—Å–µ–ª—è");
      addXP(4);

      const pet = el('petDog');
      pet.classList.remove('petted');
      void pet.offsetWidth;
      pet.classList.add('petted');

      const hearts = el('hearts');
      hearts.classList.add('show');
      setTimeout(()=>hearts.classList.remove('show'), 750);

      tg?.HapticFeedback?.impactOccurred?.("medium");
      toast("üíõ –ï–º—É –ø—Ä–∏—è—Ç–Ω–æ! +4XP");

      checkAchievements();
      await persist();
      render();
    }

    window.renameDog = async function(){
      const name = prompt("–ö–∞–∫ –Ω–∞–∑–æ–≤—ë–º –ø—ë—Å–µ–ª—è? üòÑ", state.dogName);
      if (!name) return;
      state.dogName = name.slice(0, 18);
      addLog("‚úèÔ∏è", `–ò–º—è: ${state.dogName}`);
      await persist();
      render();
      toast("–ò–º—è –æ–±–Ω–æ–≤–∏–ª ‚úÖ");
    }

    window.resetAll = async function(){
      if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë? –ò—Å—Ç–æ—Ä–∏—è, XP –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –æ–±–Ω—É–ª—è—Ç—Å—è.")) return;
      state = structuredClone(DEFAULT);
      await persist();
      render();
      toast("–°–±—Ä–æ—Å–∏–ª üóë");
    }

    window.share = function(){
      const s = state.stats;
      const msg =
`üê∂ ${state.dogName}
‚≠ê –£—Ä–æ–≤–µ–Ω—å: ${state.level}
üçó –°—ã—Ç–æ—Å—Ç—å: ${Math.round(s.hunger)}%
üòä –†–∞–¥–æ—Å—Ç—å: ${Math.round(s.happy)}%
üßº –ß–∏—Å—Ç–æ—Ç–∞: ${Math.round(s.clean)}%
‚ö° –≠–Ω–µ—Ä–≥–∏—è: ${Math.round(s.energy)}%`;
      tg?.showPopup?.({ title: "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è", message: msg, buttons: [{type:"ok"}] }) || alert(msg);
    }

    // ---------- Boot ----------
    async function boot(){
      let loaded = null;
      if (canCloud) loaded = await loadStateCloud();
      if (!loaded) loaded = loadStateLocal();

      state = loaded ? loaded : structuredClone(DEFAULT);

      // –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ —Å–ª—É—á–∞–π —Å—Ç–∞—Ä—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
      state.level ??= 1;
      state.xp ??= 0;
      state.unlocked ??= {};
      state.counts ??= { feed:0, walk:0, groom:0, train:0, rest:0, treat:0, pet:0 };

      applyDecay();
      checkAchievements();
      await persist();
      render();

      // —Ç–∏–∫ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫
      setInterval(async () => {
        applyDecay();
        checkAchievements();
        await persist();
        render();
      }, 10000);
    }

    boot();
  </script>
</body>
</html>



